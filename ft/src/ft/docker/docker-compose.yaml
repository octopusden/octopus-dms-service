version: '3'

services:
    dms-ft-dms-db:
        image: ${DOCKER_REGISTRY}/postgres:${POSTGRES_IMAGE_TAG}
        ports:
            - "5432:5432"
        environment:
            - POSTGRES_DB=dms
            - POSTGRES_USER=dms
            - POSTGRES_PASSWORD=dms
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U dms"]
            interval: 10s
            timeout: 5s
            retries: 5

    dms-ft-artifactory-db:
        image: postgres:17-alpine
        ports:
            - "5433:5432"
        environment:
            - POSTGRES_DB=${ARTIFACTORY_POSTGRES_DB}
            - POSTGRES_USER=${ARTIFACTORY_POSTGRES_USER}
            - POSTGRES_PASSWORD=${ARTIFACTORY_POSTGRES_PASSWORD}
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${ARTIFACTORY_POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 5

    dms-ft-artifactory:
        image: releases-docker.jfrog.io/jfrog/artifactory-oss:7.125.7
        depends_on:
            dms-ft-artifactory-db:
                condition: service_healthy
        ports:
            - "${ARTIFACTORY_PORT}:8081"
            - "${ARTIFACTORY_ROUTER_PORT}:8082"
        volumes:
            - ./system.yaml:/opt/jfrog/artifactory/var/etc/system.yaml
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:8081/artifactory/api/system/ping || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 40
        restart: unless-stopped

    dms-ft-components-registry-service:
        image: ${OCTOPUS_GITHUB_DOCKER_REGISTRY}/octopusden/components-registry-service:${OCTOPUS_COMPONENTS_REGISTRY_SERVICE_VERSION}
        ports:
            - "4567:4567"
        environment:
            - SPRING_CONFIG_ADDITIONAL_LOCATION=/
            - SPRING_PROFILES_ACTIVE=ft
            - SPRING_CLOUD_CONFIG_ENABLED=false
        volumes:
            - ./components-registry-service.yaml:/application-ft.yaml
            - ../../../../test-common/src/main/components-registry:/components-registry

    dms-ft-release-management-service:
        image: ${OCTOPUS_GITHUB_DOCKER_REGISTRY}/octopusden/release-management-service:${OCTOPUS_RELEASE_MANAGEMENT_SERVICE_VERSION}
        ports:
            - "8083:8083"
        environment:
            - SPRING_CONFIG_ADDITIONAL_LOCATION=/
            - SPRING_PROFILES_ACTIVE=ft
            - SPRING_CLOUD_CONFIG_ENABLED=false
            - TEST_MOCK_SERVER_HOST=${TEST_MOCK_SERVER_HOST}
        volumes:
            - ./release-management-service.yaml:/application-ft.yaml

    dms-ft-mockserver:
        image: ${DOCKER_REGISTRY}/mockserver/mockserver:mockserver-${MOCK_SERVER_VERSION}
        ports:
            - "1080:1080"

    dms-ft-dms-service:
        image: ${OCTOPUS_GITHUB_DOCKER_REGISTRY}/octopusden/dms-service:${DMS_SERVICE_VERSION}
        ports:
            - "8080:8080"
        volumes:
            - ./dms-service.yaml:/application-ft.yaml
        depends_on:
            dms-ft-dms-db:
                condition: service_healthy
            dms-ft-artifactory:
                condition: service_healthy
            dms-ft-components-registry-service:
                condition: service_started
            dms-ft-mockserver:
                condition: service_started
        environment:
            - SPRING_CONFIG_ADDITIONAL_LOCATION=/
            - SPRING_PROFILES_ACTIVE=ft
            - SPRING_CLOUD_CONFIG_ENABLED=false
            - AUTH_SERVER_URL=${AUTH_SERVER_URL}
            - AUTH_SERVER_REALM=${AUTH_SERVER_REALM}
            - TEST_API_GATEWAY_HOST_EXTERNAL=${TEST_API_GATEWAY_HOST_EXTERNAL}
            - TEST_POSTGRES_HOST=${TEST_POSTGRES_HOST}
            - TEST_MOCK_SERVER_HOST=${TEST_MOCK_SERVER_HOST}
            - TEST_ARTIFACTORY_HOST=${TEST_ARTIFACTORY_HOST}
            - TEST_ARTIFACTORY_HOST_EXTERNAL=${TEST_ARTIFACTORY_HOST_EXTERNAL}
            - TEST_COMPONENTS_REGISTRY_HOST=${TEST_COMPONENTS_REGISTRY_HOST}
            - TEST_RELEASE_MANAGEMENT_HOST=${TEST_RELEASE_MANAGEMENT_HOST}
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
            interval: 10s
            timeout: 5s
            retries: 30

    dms-ft-api-gateway:
        image: ${OCTOPUS_GITHUB_DOCKER_REGISTRY}/octopusden/api-gateway:${API_GATEWAY_VERSION}
        ports:
            - "8765:8765"
        volumes:
            - ./api-gateway.yaml:/application-ft.yaml
        environment:
            - SPRING_CONFIG_ADDITIONAL_LOCATION=/
            - SPRING_PROFILES_ACTIVE=ft
            - SPRING_CLOUD_CONFIG_ENABLED=false
            - AUTH_SERVER_URL=${AUTH_SERVER_URL}
            - AUTH_SERVER_REALM=${AUTH_SERVER_REALM}
            - AUTH_SERVER_CLIENT_ID=${AUTH_SERVER_CLIENT_ID}
            - AUTH_SERVER_CLIENT_SECRET=${AUTH_SERVER_CLIENT_SECRET}
            - TEST_DMS_SERVICE_HOST=${TEST_DMS_SERVICE_HOST}
            - TEST_API_GATEWAY_HOST_EXTERNAL=${TEST_API_GATEWAY_HOST_EXTERNAL}
        depends_on:
            dms-ft-dms-service:
                condition: service_healthy
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:8765/dms-service/actuator/health" ]
            interval: 10s
            timeout: 30s
            retries: 50